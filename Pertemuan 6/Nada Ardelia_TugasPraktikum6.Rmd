---
output: 
  html_document:
    css: "D:\\Nada\\Nada Kuliah\\Template CSS\\baru.css"
    toc: true
    toc_float: true
    number_sections: false
    theme: flatly
    highlight: tango
---

```{r,echo=FALSE, results='asis'}
cat('
<div style="position: fixed; bottom: 10px; left: 50px; color: #1C2A1A; font-weight: bold;">
  Nada Ardelia <br>
  G1401231011 <br>
</div>
')
```

# Library

```{r, message=FALSE, warning=FALSE}
library(ggplot2)
library(tsibble)
library(tseries)
library(MASS)
```

```{r, message=FALSE, warning=FALSE}
library(lattice)
library(dplyr)
```

```{r, message=FALSE, warning=FALSE}
library(forecast)
library(TSA)
library(TTR)
library(aTSA)
library(graphics)
```

# Data

```{r}
data <- read.csv("C:\\Users\\ailed\\Downloads\\Telur Ayam Ras.csv")
head(data)
```

```{r}
data_subset <- data[160:319, ]
head(data_subset)
```

```{r}
data_subset$Date <- as.Date(data_subset$Date)
```


# Partisi Data

```{r}
n <- nrow(data_subset)
train_size <- floor(0.8 * n)

# Bagi data
train_data <- data_subset[1:train_size, ]
test_data  <- data_subset[(train_size+1):n, ]

# Cek jumlah baris
nrow(train_data)
nrow(test_data)
```

## Data Train

```{r}
train_data$Date <- as.Date(train_data$Date)
```

### Plot Time Series

```{r}
plot(train_data$Date, train_data$Jawa.Barat, type = "l",
     xlab = "Tanggal", ylab = "Harga", main = "Time Series Harga di Jawa Barat")
```

```{r}
mean(train_data$Jawa.Barat, na.rm = TRUE)
```

```{r}
densityplot(as.vector(train_data$Jawa.Barat),
            main = "Density Plot Harga Jawa Barat",
            xlab = "Harga")
```

### Plot ACF

```{r}
harga_train <- na.omit(train_data$Jawa.Barat)
acf(harga_train, main = "ACF - Harga Telur Jawa Barat")
```

Berdasarkan plot ACF, terlihat bahwa plot ACF pada data tersebut cenderung tails off.


### Uji ADF

$H_0$: Data tidak stasioner dalam rataan

$H_1$: Data stasioner dalam rataan

```{r}
tseries::adf.test(harga_train)
```

Berdasarkan hasil uji ADF, p-value > 0,05 sehingga tolak H0 dan menandakan bahwa data *tidak stasioner dalam rataan*.  Hal ini sesuai dengan hasil eksplorasi menggunakan plot time series dan plot ACF.

### Plot Box Cox

```{r}
index <- seq_along(harga_train)

# Plot Box-Cox
bc_train <- boxcox(harga_train - min(harga_train) + 1 ~ index, lambda = seq(-2, 4, by = 0.01))

```

```{r}
# Nilai lambda maksimum (optimum)
lambda_train <- bc_train$x[which.max(bc_train$y)]
lambda_train
```

```{r}
# Hitung selang kepercayaan 95%

# CI lambda: nilai log-likelihood maksimum - chi-square
ci_lambda_train <- bc_train$x[bc_train$y > max(bc_train$y) - 0.5 * qchisq(0.95, 1)]

# Batas bawah dan atas
ci_lower_train <- min(ci_lambda_train)
ci_upper_train <- max(ci_lambda_train)

# Tampilkan hasil
c(Batas_Bawah = ci_lower_train, Batas_Atas = ci_upper_train)

```
Gambar di atas menunjukkan nilai λ optimum (rounded value) sebesar 0,53 dan selang kepercayaan 95% nilai memiliki batas bawah 0,39 dan batas atas 0,69. Selang tersebut *tidak memuat nilai satu* sehingga dapat dikatakan bahwa data harga *tidak stasioner dalam ragam*.


### Differencing 1

```{r}
diff11 <- diff(harga_train, differences = 1)
plot.ts(diff11, main = "First-order Differencing", col = "blue", lwd = 2)
```

```{r}
adf.test(diff11)
```

p-value > 0,05 sehingga masih tidak stasioner, maka akan coba differencing ke 2 kali.

### Differencing 2

```{r}
diff22 <- diff(harga_train, differences = 2)
plot.ts(diff22, main = "Second-order Differencing", col = "red", lwd = 2)
```

```{r}
adf.test(diff22)
```

```{r}
acf(diff22, main = "ACF setelah Differencing 2")
```


Data sudah stasioner terhadap rataan.


```{r}
# Data digeser agar positif
diff22_train_geser <- diff22 - min(diff22) + 1
```

### Plot Box Cox 2

```{r}
index <- seq_along(diff22_train_geser)

# Plot Box-Cox
bc_train2 <- boxcox(diff22_train_geser ~ index, lambda = seq(-2, 4, by = 0.01))

```


```{r}
# Nilai lambda maksimum (optimum)
lambda_train2 <- bc_train2$x[which.max(bc_train2$y)]
lambda_train2
```

```{r}
# Hitung selang kepercayaan 95%

# CI lambda: nilai log-likelihood maksimum - chi-square
ci_lambda_train2 <- bc_train2$x[bc_train2$y > max(bc_train2$y) - 0.5 * qchisq(0.95, 1)]

# Batas bawah dan atas
ci_lower_train2 <- min(ci_lambda_train2)
ci_upper_train2 <- max(ci_lambda_train2)

# Tampilkan hasil
c(Batas_Bawah2 = ci_lower_train2, Batas_Atas2 = ci_upper_train2)

```
Gambar di atas menunjukkan nilai λ optimum (rounded value) sebesar 1,22 dan selang kepercayaan 95% nilai memiliki batas bawah 0,92 dan batas atas 1,60. Selang tersebut *memuat nilai satu* sehingga dapat dikatakan bahwa data *stasioner dalam ragam*. Data sudah stasioner dalam ragam dan rataan.

# Spesifikasi Model

```{r}
par(mfrow = c(1,2))
acf(diff22_train_geser, main="ACF", lag.max=20) 
pacf(diff22_train_geser, main="PACF", lag.max=20) 
```
```{r}
par(mfrow = c(1,1))
```


Berdasarkan Plot ACF, terlihat cuts off pada lag ke-2 sehingga dapat kita asumsikan model yang terbentuk adalah ARIMA(0,2,2). Selanjutnya, berdasarkan plot PACF, terlihat cuts off pada lag ke-2 sehingga model yang terbentuk adalah ARIMA(2,2,0). Selain dengan plot ACF dan PACF, penentuan spesifikasi model dilakukan dengan extended ACF (EACF) berikut ini.


```{r}
eacf(diff22_train_geser) 
```
Menggunakan plot EACF, dapat diambil beberapa model lain dengan melihat ujung segitiga yang terbentuk, antara lain ARIMA (0,2,4) dan ARIMA (1,2,4).

# Pendugaan Parameter

```{r}
model1.ma2=Arima(diff22_train_geser, order=c(0,2,2),method="ML")
summary(model1.ma2) 
```
```{r}
lmtest::coeftest(model1.ma2)
```

Seluruh parameter signifikan.

```{r}
model2.ma2=Arima(diff22_train_geser, order=c(2,2,0),method="ML") 
summary(model2.ma2) 
```
```{r}
lmtest::coeftest(model2.ma2)
```
```{r}
model3.ma2=Arima(diff22_train_geser, order=c(0,2,4),method="ML") 
summary(model3.ma2) 
```

```{r}
lmtest::coeftest(model3.ma2)
```

Semua signifikan.

```{r}
model4.ma2=Arima(diff22_train_geser, order=c(1,2,4),method="ML") 
summary(model4.ma2) 
```

```{r}
lmtest::coeftest(model4.ma2)
```
ma2 tidak signifikan.

```{r}
hasil_model <- data.frame(
  Model = c("ARIMA(0,2,2)",
            "ARIMA(2,2,0)",
            "ARIMA(0,2,4)",
            "ARIMA(1,2,4)"
  ),
  
  AIC = c(
    AIC(model1.ma2),
    AIC(model2.ma2),
    AIC(model3.ma2),
    AIC(model4.ma2)
  ),
  
  BIC = c(
    BIC(model1.ma2),
    BIC(model2.ma2),
    BIC(model3.ma2),
    BIC(model4.ma2)
  )
)

hasil_model
```
Berdasarkan pendugaan parameter di atas, nilai AIC terkecil dimiliki oleh model ARIMA(0,2,4) dan parameter model ARIMA(0,2,4) juga seluruhnya signifikan sehingga model yang dipilih adalah model ARIMA(0,2,4).

# Analisis Sisaan

## Eksplorasi Sisaan

```{r}
#Eksplorasi
sisaan.ma2 <- model3.ma2$residuals
par(mfrow=c(2,2))

#qqnorm(sisaan.ma2)
#qqline(sisaan.ma2, col = "blue", lwd = 2)
car::qqPlot(sisaan.ma2)
```


```{r}
plot(c(1:length(sisaan.ma2)),sisaan.ma2)

# ACFF dan PACF sisaan
acf(sisaan.ma2)
pacf(sisaan.ma2)
```

Berdasarkan plot kuantil-kuantil normal, secara eksplorasi ditunjukkan sisaan menyebar normal mengikuti garis. Kemudian dapat dilihat juga lebar pita sisaan yang cenderung sama menandakan bahwa sisaan memiliki ragam yang homogen. 

## Uji Formal

```{r}
#1) Sisaan Menyebar Normal
ks.test(sisaan.ma2,"pnorm") 
```
 H0: Sisaan menyebar normal

 H1: Sisaan tidak menyebar normal

Berdasarkan uji KS tersebut, didapat p-value < 0,05 sehingga tolak 
 dan menandakan bahwa sisaan tidak menyebar normal. Hal ini tidak sesuai dengan hasil eksplorasi menggunakan plot kuantil-kuantil normal.
 
```{r}
#2) Sisaan saling bebas/tidak ada autokorelasi
Box.test(sisaan.ma2, type = "Ljung") 
```

Selanjutnya akan dilakukan uji formal untuk kebebasan sisaan menggunakan uji Ljung-Box. Hipotesis yang digunakan adalah sebagai berikut.

 H0: Sisaan saling bebas

 H1: Sisaan tidak tidak saling bebas

Berdasarkan uji Ljung-Box tersebut, didapat p-value sebesar 0.6249 yang lebih besar dari taraf nyata 5% sehingga gagal tolak dan menandakan bahwa sisaan saling bebas.

```{r}
#3) Sisaan homogen
Box.test((sisaan.ma2)^2, type = "Ljung") 
```

Hipotesis yang digunakan untuk uji kehomogenan ragam adalah sebagai berikut.

H0: Ragam sisaan homogen

H1: Ragam sisaan tidak homogen

Berdasarkan uji Ljung-Box terhadap sisaan kuadrat tersebut, didapat p-value < 0,05 sehingga tolak dan menandakan bahwa ragam sisaan tidak homogen.

```{r}
#4) Nilai tengah sisaan sama dengan nol
t.test(sisaan.ma2, mu = 0, conf.level = 0.95) 
```
Terakhir, dengan uji-t, akan dicek apakah nilai tengah sisaan sama dengan nol. Hipotesis yang diujikan sebagai berikut.

H0: nilai tengah sisaan sama dengan 0

H1: nilai tengah sisaan tidak sama dengan 0

Berdasarkan uji-ttersebut, didapat p-value sebesar 0.9002 yang lebih besar dari taraf nyata 5% sehingga gagal tolak dan menandakan bahwa nilai tengah sisaan sama dengan nol.

# Overfitting

```{r}
model3a.ma2=Arima(diff22_train_geser, order=c(0,2,3),method="ML")
summary(model3a.ma2) 
```

```{r}
lmtest::coeftest(model3a.ma2)
```
```{r}
model3b.ma2=Arima(diff22_train_geser, order=c(2,2,4),method="ML")
summary(model3b.ma2) 
```
```{r}
lmtest::coeftest(model3b.ma2)
```
ma2 tidak signifikan.


```{r}
overfitting <- data.frame(
  Model = c("ARIMA(0,2,3)","ARIMA(0,2,4)", "ARIMA(2,2,4)"),
  AIC   = c(AIC(model3a.ma2),AIC(model3.ma2), AIC(model3b.ma2)),
  BIC   = c(BIC(model3a.ma2),BIC(model3.ma2), BIC(model3b.ma2))
)

overfitting
```

Berdasarkan kedua model hasil overfitting di atas, model ARIMA(0,2,3) dan ARIMA(0,2,4) memiliki AIC yang lebih besar dibandingkan dengan model ARIMA(2,2,4) dan parameter model ARIMA(2,2,4) ada yang tidak signifikan. Oleh karena itu, model ARIMA(2,2,4) yang akan digunakan untuk melakukan peramalan.


# Peramalan

```{r}
#---FORECAST---#
ramalan <- forecast::forecast(model3b.ma2, h = 32) 
ramalan
```

```{r}
data.ramalan <- ramalan$mean
plot(ramalan)
```

Berdasarkan hasil plot ramalan di atas, dapat dilihat bahwa ramalan ARIMA(2,2,4) cenderung fultuatif di awal periode dan stabil hingga akhir periode. Selanjutnya, dapat dicari nilai akurasi antara hasil ramalan dengan data uji sebagai berikut.

```{r}
perbandingan<-matrix(data=c(test_data$Jawa.Barat, data.ramalan),
                     nrow = 32, ncol = 2)
colnames(perbandingan)<-c("Aktual","Hasil Forecast")
perbandingan
```
```{r}
# Akurasi
accuracy(data.ramalan, test_data$Jawa.Barat)
```

>MAPE = 96.26% berarti rata-rata ramalan salah sebesar 96.26% dari nilai sebenarnya.

>Ini menunjukkan bahwa model kurang akurat, dan hasil ramalan tidak bisa digunakan untuk pengambilan keputusan.

>Nilai error lainnya (MAE dan RMSE) juga besar, menandakan deviasi yang tinggi antara nilai aktual dan prediksi.